<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<script src="http://www.mapquestapi.com/sdk/leaflet/v1.0/mq-map.js?key=Fmjtd%7Cluur20uznh%2C8g%3Do5-9ay01f"></script>

<script src="http://code.jquery.com/jquery-2.1.1.js"></script>
<script src="http://open.mapquestapi.com/sdk/js/v7.1.0/mqa.toolkit.js?key=Fmjtd%7Cluur20uznh%2C8g%3Do5-9ay01f"></script>
<script>
// To test locally, you'll need to run a web server so that AJAX works.
// "all" gets populated from the file all.geojson, via AJAX.
var all = null
var where = 0
$(document).keypress(function(e){
  if(e.keyCode == 112) {
    // 'p' for previous
    where -= 1
  } else {
    where += 1
  }
  if(where < 0) {
    where = 0
  }
  if(where >= all.features.length) {
    where = all.features.length - 1
  }
  showWhere()
})
marker = null
function showWhere() {
  var station = all.features[where]
  var url = station.properties.id + ".svg"
  var frag = url.substr(0, url.indexOf('.'))
  window.location.hash = '#'+frag
  $('#plot').attr('src', url)
  if(marker) {
    map.removeLayer(marker)
  }
  // GeoJSON convention, [longitude, latitude]
  var coords = station.geometry.coordinates
  // leaflet.js convention, [latitude, longitude]
  var latlon = [coords[1], coords[0]]
  marker = L.marker(latlon)
  marker.addTo(map)
  map.panTo(latlon)
}
$(function() {
  $.ajax("all.geojson", {dataType:"json"}).done(function(data) {
    all = data
    if (window.location.hash) {
        var i, n
        var s = window.location.hash.substr(1)
        if(s.length < 11) {
            where = parseInt(s);
        } else {
            n = s.length
            for(i=0; i<all.features.length; ++i) {
                if(all.features[i].properties.id.substr(0, n) == s) {
                    where = i
                    break
                }
            }
        }
    } else {
        where = Math.floor(Math.random()*all.features.length)
    }

    showWhere()
  }).error(function(foo){
    console.log("I'm error", foo)
  })

  // The "if" here, let's us work offline.
  if(window.L) {
    map = L.map('map', {
        layers: MQ.mapLayer(),
        center: [ 40.731701, -73.993411 ],
        zoom: 9
    });
  }
})
</script>
<style>
body {
  position: relative;
  width:100%;
  height:100%;
}
#plot {
  position: absolute;
  top: 20px;
  left: 20px;
}
html, body {
  padding:0;
  margin:0;
}
</style>

<body>
<div id="map" style="width:100%; height:100%;">
</div>
<img id="plot" src="40178954000.svg">
</body>
